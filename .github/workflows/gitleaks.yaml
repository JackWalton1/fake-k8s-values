name: Gitleaks Dry Run

on:
  push:
    branches:
      - '**'   # Run on all branches
  workflow_dispatch:  # Allow manual runs too

jobs:
  gitleaks:
    runs-on: ubuntu-latest

    steps:
      # --- Checkout full history so diffs work reliably ---
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # --- Determine changed files ---
      - name: Determine changed files since last commit on branch
        id: changes
        run: |
          set -e

          DEFAULT_BRANCH="${{ github.event.repository.default_branch }}"
          BEFORE_SHA="${{ github.event.before }}"
          AFTER_SHA="${{ github.sha }}"

          echo "Default branch: $DEFAULT_BRANCH"
          echo "Before SHA: $BEFORE_SHA"
          echo "After  SHA: $AFTER_SHA"

          # Handle first commit on a new branch (no before SHA)
          if [[ "$BEFORE_SHA" == "0000000000000000000000000000000000000000" || -z "$BEFORE_SHA" ]]; then
            echo "New branch detected – comparing against origin/$DEFAULT_BRANCH"
            git fetch origin $DEFAULT_BRANCH --depth=1
            CHANGED_FILES=$(git diff --name-only origin/$DEFAULT_BRANCH..$AFTER_SHA | tr '\n' ' ')
          else
            echo "Comparing previous commit $BEFORE_SHA → $AFTER_SHA"
            git fetch origin $BEFORE_SHA --depth=1 || true
            CHANGED_FILES=$(git diff --name-only $BEFORE_SHA $AFTER_SHA | tr '\n' ' ')
          fi

          echo "files=${CHANGED_FILES}" >> $GITHUB_OUTPUT
          echo "Changed files: $CHANGED_FILES"

      # --- Run Gitleaks on changed files ---
      - name: Run Gitleaks on changed files (dry run)
        if: steps.changes.outputs.files != ''
        run: |
          docker pull zricethezav/gitleaks:v8.28.0
          for file in ${{ steps.changes.outputs.files }}; do
            echo "Scanning $file for exposed secrets"
            docker run --rm -v $PWD:/path zricethezav/gitleaks:v8.28.0 dir \
              "/path/$file" \
              --config /path/.gitleaks.toml \
              --report-format json \
              --report-path "/path/gitleaks-report-$(basename $file).json" \
              --redact --verbose 
          done
          
      # --- Parse report for quick summary ---
      - name: Parse report (show rule names only)
        if: always()
        run: |
          if ls gitleaks-report-*.json 1> /dev/null 2>&1; then
            if grep -q '[^[:space:]\[\]]' gitleaks-report-*.json; then
              echo "Findings:"
              jq -r '.[] | "Rule: \(.Description), File: \(.File), Line: \(.StartLine)"' gitleaks-report-*.json
            else
              echo "No findings detected in reports."
            fi
          else
            echo "No reports generated."
          fi

