name: Gitleaks Dry Run

on:
  push:
    branches:
      - '**'  # Run on all branches
  workflow_dispatch:  # Allow manual runs too

jobs:
  gitleaks:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for accurate diffs

      - name: Determine changed files vs default branch tip
        id: changes
        run: |
          DEFAULT_BRANCH="${{ github.event.repository.default_branch }}"
          git fetch origin $DEFAULT_BRANCH 

          AFTER_SHA="${{ github.sha }}"

          echo "Comparing origin/$DEFAULT_BRANCH (remote tip) to $AFTER_SHA"
          CHANGED_FILES=$(git diff --name-only origin/$DEFAULT_BRANCH..$AFTER_SHA | tr '\n' ' ')
          
          echo "files=${CHANGED_FILES}" >> $GITHUB_OUTPUT
          echo "Changed files: $CHANGED_FILES"


      - name: Run Gitleaks (dry run)
        if: steps.changes.outputs.files != ''
        run: |
          docker pull zricethezav/gitleaks:v8.28.0
          for file in ${{ steps.changes.outputs.files }}; do
            echo "Scanning $file"
            docker run --rm -v $PWD:/path zricethezav/gitleaks:v8.28.0 detect \
              --source "/path/$file" \
              --config /path/.gitleaks.toml \
              --report-format json \
              --report-path "/path/gitleaks-report-$(basename $file).json" \
              --redact --verbose || true
          done

      - name: Parse report (show rule names only)
        if: always()
        run: |
          if ls gitleaks-report-*.json 1> /dev/null 2>&1; then
            if grep -q '[^[:space:]\[\]]' gitleaks-report-*.json; then
              echo "Findings:"
              jq -r '.[] | "Rule: \(.Description), File: \(.File), Line: \(.StartLine)"' gitleaks-report-*.json
            else
              echo "No findings detected in reports."
            fi
          else
            echo "No reports generated."
          fi

      - name: Upload Gitleaks reports (for review)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gitleaks-dryrun-reports
          path: gitleaks-report-*.json
